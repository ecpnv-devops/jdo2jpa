#
# This YAML defines a structured, step-by-step guide to migrate classes and code from JDO-specific annotations
# to their JPA equivalents.
#
# The main recipe executes all recipes necessary to migrate from JDO to JPA.
#
# NOTE: The main recipe doesn't cover all possible JDO ORM mapping variations possible, but is restricted to most
#       common cases. Please feel free to extend the recipes with additional JDO mapping coverage.
#
# @author Patrick Deenen @ Open Circle Solutions
#

---
type: specs.openrewrite.org/v1beta/recipe
name: com.ecpnv.openrewrite.jdo2jpa.v2x
displayName: Migrate from JDO to JPA v2.x
description: This main recipe migrates JDO applications using (Datanucleus) JDO to Java Persistence using JPA version v2.x (pre Jakarta persistence).
tags:
  - jdo
  - jpa
  - migrate
  - modernize
  - java
  - javax
  - persistence
recipeList:
  - com.ecpnv.openrewrite.jdo2jpa.v2x.PersistenceCapable
  - com.ecpnv.openrewrite.jdo2jpa.v2x.Persistent
  - com.ecpnv.openrewrite.jdo2jpa.v2x.Column
  - org.openrewrite.java.ReplaceAnnotation:
      annotationPatternToReplace: '@javax.jdo.annotations.NotPersistent'
      annotationTemplateToInsert: '@javax.persistence.Transient'
  - com.ecpnv.openrewrite.jdo2jpa.v2x.Unique
  - com.ecpnv.openrewrite.jdo2jpa.v2x.Index
  - com.ecpnv.openrewrite.jdo2jpa.v2x.Discriminator
  - com.ecpnv.openrewrite.jdo2jpa.v2x.Inheritance
  # Post code changes
  - com.ecpnv.openrewrite.jdo2jpa.v2x.cleanup
---
type: specs.openrewrite.org/v1beta/recipe
name: com.ecpnv.openrewrite.jdo2jpa.v2x.PersistenceCapable
displayName: Migrate JDO > JPA-v2.x for @PersistenceCapable
description: Migrate @PersistenceCapable to @Entity and @Table.
tags:
  - jdo
  - jpa
  - migrate
  - modernize
  - java
  - javax
  - persistence
  - PersistenceCapable
recipeList:
  - com.ecpnv.openrewrite.jdo2jpa.AddCommentToPersistenceCapableWithIdentityTypeApplication
  - com.ecpnv.openrewrite.jdo2jpa.ExtendWithAbstractEntityForPersistenceCapableAnnotation:
      extendsFullClassName: org.estatio.base.prod.dom.EntityAbstract
      libraryOfAbstractClassName: jdo2jpa-abstract
  - com.ecpnv.openrewrite.jdo2jpa.AddEntityAnnotation
  - com.ecpnv.openrewrite.jdo2jpa.ReplacePersistenceCapableWithTableAnnotation
  - org.openrewrite.java.RemoveAnnotation:
      annotationPattern: '@javax.jdo.annotations.PersistenceCapable'
  - com.ecpnv.openrewrite.java.MaybeRemoveImport:
      type: javax.jdo.annotations.IdentityType
---
type: specs.openrewrite.org/v1beta/recipe
name: com.ecpnv.openrewrite.jdo2jpa.v2x.Persistent
displayName: Migrate JDO > JPA-v2.x for @Persistent
description: Migrate @Persistent to @OneToMany and @Column.
tags:
  - jdo
  - jpa
  - migrate
  - modernize
  - java
  - javax
  - persistence
  - Persistent
recipeList:
  - com.ecpnv.openrewrite.jdo2jpa.ReplacePersistentWithManyToOneAnnotation:
      defaultCascade: 'CascadeType.PERSIST, CascadeType.MERGE, CascadeType.REFRESH, CascadeType.DETACH'
  - com.ecpnv.openrewrite.jdo2jpa.ReplacePersistentWithOneToManyAnnotation:
      defaultCascade: 'CascadeType.PERSIST, CascadeType.MERGE, CascadeType.REFRESH, CascadeType.DETACH'
  - org.openrewrite.java.RemoveAnnotationAttribute:
      annotationType: javax.jdo.annotations.Persistent
      attributeName: defaultFetchGroup
  - com.ecpnv.openrewrite.java.RemoveAnnotationWithoutAttributes:
      annotationType: '@javax.jdo.annotations.Persistent'
---
type: specs.openrewrite.org/v1beta/recipe
name: com.ecpnv.openrewrite.jdo2jpa.v2x.Column
displayName: Migrate JDO > JPA-v2.x for @Column
description: Migrate @Column.
tags:
  - jdo
  - jpa
  - migrate
  - modernize
  - java
  - javax
  - persistence
  - Persistent
recipeList:
  # replace @Column(..allowsNull..) with @Column(..nullable..)
  - org.openrewrite.java.ChangeAnnotationAttributeName:
      annotationType: javax.jdo.annotations.Column
      oldAttributeName: allowsNull
      newAttributeName: nullable
  # Remove nullable = "true" as this is the default in JPA
  - com.ecpnv.openrewrite.java.RemoveAnnotationAttributeConditionally:
      matchByRegularExpression: '@Column\(.*nullable\s*=\s*"true".*\)'
      annotationType: javax.jdo.annotations.Column
      attributeName: nullable
  # Change nullable = "false" to nullable = false
  - com.ecpnv.openrewrite.java.AddOrUpdateAnnotationAttribute:
      annotationType: javax.jdo.annotations.Column
      attributeName: nullable
      oldAttributeValue: "false"
      attributeValue: false
      operation: UPDATE
      appendArray: false
  # replace 'jdbcType = "CLOB", sqlType = "LONGVARCHAR"' with @Lob
  - com.ecpnv.openrewrite.java.AddAnnotationConditionally:
      matchByRegularExpression: '@Column\(.*jdbcType\s*=\s*"CLOB".*\)'
      annotationType: javax.persistence.Lob
      annotationTemplate: '@Lob'
      declarationType: VAR
  - com.ecpnv.openrewrite.java.AddAnnotationConditionally:
      matchByRegularExpression: '@Column\(.*jdbcType\s*=\s*"CLOB".*\)'
      annotationType: javax.persistence.Lob
      annotationTemplate: '@Lob'
      declarationType: METHOD
  - com.ecpnv.openrewrite.java.AddAnnotationConditionally:
      matchByRegularExpression: '@Column\(.*jdbcType\s*=\s*"CLOB".*\)'
      annotationType: javax.persistence.Lob
      annotationTemplate: '@Lob'
      declarationType: CLASS
  - org.openrewrite.java.RemoveAnnotationAttribute:
      annotationType: javax.jdo.annotations.Column
      attributeName: jdbcType
  - org.openrewrite.java.RemoveAnnotationAttribute:
      annotationType: javax.jdo.annotations.Column
      attributeName: sqlType
  # Change column type
  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: javax.jdo.annotations.Column
      newFullyQualifiedTypeName: javax.persistence.Column
---
type: specs.openrewrite.org/v1beta/recipe
name: com.ecpnv.openrewrite.jdo2jpa.v2x.Unique
displayName: Migrate JDO > JPA-v2.x for @Unique
description: Migrate @Unique and @Uniques.
tags:
  - jdo
  - jpa
  - migrate
  - modernize
  - java
  - javax
  - persistence
  - Persistent
recipeList:
  # replace @Unique(..members..) with @Unique(..columnNames..)
  - org.openrewrite.java.ChangeAnnotationAttributeName:
      annotationType: javax.jdo.annotations.Unique
      oldAttributeName: members
      newAttributeName: columnNames
  # remove unsupported attributes
  - org.openrewrite.java.RemoveAnnotationAttribute:
      annotationType: javax.jdo.annotations.Unique
      attributeName: table
  - org.openrewrite.java.RemoveAnnotationAttribute:
      annotationType: javax.jdo.annotations.Unique
      attributeName: deferred
  - org.openrewrite.java.RemoveAnnotationAttribute:
      annotationType: javax.jdo.annotations.Unique
      attributeName: columns
  - org.openrewrite.java.RemoveAnnotationAttribute:
      annotationType: javax.jdo.annotations.Unique
      attributeName: extensions
  # Change Unique type
  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: javax.jdo.annotations.Unique
      newFullyQualifiedTypeName: javax.persistence.UniqueConstraint
  # Move annotation to other annotation attribute
  - com.ecpnv.openrewrite.java.MoveAnnotationsToAttribute:
      sourceAnnotationType: javax.persistence.UniqueConstraint
      targetAnnotationType: javax.persistence.Table
      targetAttributeName: uniqueConstraints
  # Remove @uniques
  - org.openrewrite.java.RemoveAnnotation:
      annotationPattern: '@javax.jdo.annotations.Uniques'
---
type: specs.openrewrite.org/v1beta/recipe
name: com.ecpnv.openrewrite.jdo2jpa.v2x.Index
displayName: Migrate JDO > JPA-v2.x for @Index
description: Migrate @Index.
tags:
  - jdo
  - jpa
  - migrate
  - modernize
  - java
  - javax
  - persistence
  - Persistent
recipeList:
  # replace @Index(..members..) with @Index(..columnList..)
  - org.openrewrite.java.ChangeAnnotationAttributeName:
      annotationType: javax.jdo.annotations.Index
      oldAttributeName: members
      newAttributeName: columnList
  # remove unsupported attributes
  - org.openrewrite.java.RemoveAnnotationAttribute:
      annotationType: javax.jdo.annotations.Index
      attributeName: table
  - org.openrewrite.java.RemoveAnnotationAttribute:
      annotationType: javax.jdo.annotations.Index
      attributeName: unique
  - org.openrewrite.java.RemoveAnnotationAttribute:
      annotationType: javax.jdo.annotations.Index
      attributeName: columns
  - org.openrewrite.java.RemoveAnnotationAttribute:
      annotationType: javax.jdo.annotations.Index
      attributeName: extensions
  # Change Index type
  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: javax.jdo.annotations.Index
      newFullyQualifiedTypeName: javax.persistence.Index
  # Join the column names in the array to comma separated string
  - com.ecpnv.openrewrite.java.JoinStringArrayAnnotationAttribute:
      annotationType: javax.persistence.Index
      attributeName: columnList
      delimiter: ", "
  # Move Index annotation to Table annotation attribute
  - com.ecpnv.openrewrite.java.MoveAnnotationsToAttribute:
      sourceAnnotationType: javax.persistence.Index
      targetAnnotationType: javax.persistence.Table
      targetAttributeName: indexes
---
type: specs.openrewrite.org/v1beta/recipe
name: com.ecpnv.openrewrite.jdo2jpa.v2x.Discriminator
displayName: Migrate JDO > JPA-v2.x for @Discriminator
description: Migrate @Discriminator and @DiscriminatorStrategy.
tags:
  - jdo
  - jpa
  - migrate
  - modernize
  - java
  - javax
  - persistence
  - Persistent
recipeList:
  # Translate discriminator strategy of class name to discriminator values with the names of the classes
  # by copying @Discriminator from parent class to subclasses when omitted and use the subclass name
  - com.ecpnv.openrewrite.jdo2jpa.CopyDiscriminatorFromParent
  # Add @DiscriminatorColumn for every @Discriminator
  # Set discriminator column name: discriminator
  # Set discriminator column length: 255
  # Note that from v5.0.2 DataNucleus will use a discriminator by default for inheritance strategy single table
  - com.ecpnv.openrewrite.java.AddAnnotationConditionally:
      matchByRegularExpression: '@Discriminator.*'
      annotationType: javax.persistence.DiscriminatorColumn
      annotationTemplate: '@DiscriminatorColumn( name = "discriminator", length = 255)'
      declarationType: CLASS
  # Change type of @Discriminator to @DiscriminatorValue
  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: javax.jdo.annotations.Discriminator
      newFullyQualifiedTypeName: javax.persistence.DiscriminatorValue
  # Remove attributes which are not applicable
  - org.openrewrite.java.RemoveAnnotationAttribute:
      annotationType: javax.persistence.DiscriminatorValue
      attributeName: strategy
  - org.openrewrite.java.RemoveAnnotationAttribute:
      annotationType: javax.persistence.DiscriminatorValue
      attributeName: column
  - org.openrewrite.java.RemoveAnnotationAttribute:
      annotationType: javax.persistence.DiscriminatorValue
      attributeName: columns
  - org.openrewrite.java.RemoveAnnotationAttribute:
      annotationType: javax.persistence.DiscriminatorValue
      attributeName: indexed
  - com.ecpnv.openrewrite.java.MaybeRemoveImport:
      type: javax.jdo.annotations.DiscriminatorStrategy
---
type: specs.openrewrite.org/v1beta/recipe
name: com.ecpnv.openrewrite.jdo2jpa.v2x.Inheritance
displayName: Migrate JDO > JPA-v2.x for @Inheritance
description: Migrate @Inheritance and @InheritanceStrategy.
tags:
  - jdo
  - jpa
  - migrate
  - modernize
  - java
  - javax
  - persistence
  - Persistent
recipeList:
  # Change inheritance strategy from SUBCLASS_TABLE to mapped superclass
  - com.ecpnv.openrewrite.java.AddAnnotationConditionally:
      matchByRegularExpression: '@Inheritance\(.*strategy\s*=\s*InheritanceStrategy.SUBCLASS_TABLE.*\)'
      annotationType: javax.persistence.MappedSuperclass
      annotationTemplate: '@MappedSuperclass'
      declarationType: CLASS
  - org.openrewrite.java.RemoveAnnotation:
      annotationPattern: '@javax.jdo.annotations.Inheritance(strategy=javax.jdo.annotations.InheritanceStrategy.SUBCLASS_TABLE)'
  # Remove @Inheritance from subclasses
  - com.ecpnv.openrewrite.java.RemoveInheritedAnnotations:
      nonInheritedAnnotationTypes:
        - javax.jdo.annotations.Inheritance
  # Change type of @Inheritance
  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: javax.jdo.annotations.Inheritance
      newFullyQualifiedTypeName: javax.persistence.Inheritance
  # Set inheritance strategy to the causeway default: table_per_class(==new table) translates into JOINED
  - com.ecpnv.openrewrite.java.AddOrUpdateAnnotationAttribute:
      annotationType: javax.persistence.Inheritance
      attributeName: strategy
      oldAttributeValue: "null"
      attributeValue: javax.persistence.InheritanceType.JOINED
      operation: ADD
      appendArray: false
  # Change inheritance strategy from NEW_TABLE to JOINED
  - com.ecpnv.openrewrite.java.AddOrUpdateAnnotationAttribute:
      annotationType: javax.persistence.Inheritance
      attributeName: strategy
      oldAttributeValue: InheritanceStrategy.NEW_TABLE
      attributeValue: javax.persistence.InheritanceType.JOINED
      operation: UPDATE
      appendArray: false
  # Change inheritance strategy from SUPERCLASS_TABLE to SINGLE_TABLE
  - com.ecpnv.openrewrite.java.AddOrUpdateAnnotationAttribute:
      annotationType: javax.persistence.Inheritance
      attributeName: strategy
      oldAttributeValue: InheritanceStrategy.SUPERCLASS_TABLE
      attributeValue: javax.persistence.InheritanceType.SINGLE_TABLE
      operation: UPDATE
      appendArray: false
  # Change inheritance strategy from COMPLETE_TABLE to TABLE_PER_CLASS
  - com.ecpnv.openrewrite.java.AddOrUpdateAnnotationAttribute:
      annotationType: javax.persistence.Inheritance
      attributeName: strategy
      oldAttributeValue: InheritanceStrategy.COMPLETE_TABLE
      attributeValue: javax.persistence.InheritanceType.TABLE_PER_CLASS
      operation: UPDATE
      appendArray: false
  # Remove customStrategy
  - org.openrewrite.java.RemoveAnnotationAttribute:
      annotationType: javax.persistence.Inheritance
      attributeName: customStrategy
  - com.ecpnv.openrewrite.java.MaybeRemoveImport:
      type: javax.jdo.annotations.InheritanceStrategy
---
type: specs.openrewrite.org/v1beta/recipe
name: com.ecpnv.openrewrite.jdo2jpa.v2x.cleanup
displayName: Cleanup
description: Run cleanup.
tags:
  - cleanup
recipeList:
  - com.ecpnv.openrewrite.java.ShortenFullyQualifiedTypeReferencesConditionally:
      excludePackages: lombok,org.estatio.module.atpath.dom,org.incode.module.classification.dom.impl.category,org.estatio.module.asset.dom,org.apache.isis.applib.value,org.incode.module.document.dom.impl.docs
  - com.ecpnv.openrewrite.jdo2jpa.RemovedUnusedImportsSpringSupport
# too soon
#  - org.openrewrite.java.format.AutoFormat
