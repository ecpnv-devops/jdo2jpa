#
# This YAML defines a structured, step-by-step guide to migrate classes and code from JDO-specific annotations
# to their JPA equivalents.
#
# This is the main recipe to execute all recipes nessecary to migrate from JDO to JPA.
#
# author patrick.deenen@opencirclesolutions.nl
#

---
type: specs.openrewrite.org/v1beta/recipe
name: com.ecpnv.openrewrite.jdo2jpa.v2x
displayName: Migrate from JDO to JPA v2.x
description: These recipes help migrate JDO applications using Datanucleus JDO to Java Persistence using JPA version v2.x (pre Jakarta persistence).
tags:
  - jdo
  - jpa
  - migrate
  - modernize
  - java
  - javax
  - persistence
recipeList:
  - com.ecpnv.openrewrite.jdo2jpa.v2x.PersistenceCapable
  - com.ecpnv.openrewrite.jdo2jpa.v2x.Persistent
  - com.ecpnv.openrewrite.jdo2jpa.v2x.Column
  - org.openrewrite.java.ReplaceAnnotation:
      annotationPatternToReplace: '@javax.jdo.annotations.NotPersistent'
      annotationTemplateToInsert: '@javax.persistence.Transient'
  - org.openrewrite.java.ShortenFullyQualifiedTypeReferences
  - org.openrewrite.java.RemoveUnusedImports
---
type: specs.openrewrite.org/v1beta/recipe
name: com.ecpnv.openrewrite.jdo2jpa.v2x.PersistenceCapable
displayName: Migrate JDO > JPA-v2.x for @PersistenceCapable
description: Migrate @Persistence to @Entity and @Table.
tags:
  - jdo
  - jpa
  - migrate
  - modernize
  - java
  - javax
  - persistence
  - PersistenceCapable
recipeList:
  - com.ecpnv.openrewrite.jdo2jpa.AddEntityAnnotation
  - com.ecpnv.openrewrite.jdo2jpa.ReplacePersistenceCapableWithTableAnnotation
  - org.openrewrite.java.RemoveAnnotation:
      annotationPattern: '@javax.jdo.annotations.PersistenceCapable'
---
type: specs.openrewrite.org/v1beta/recipe
name: com.ecpnv.openrewrite.jdo2jpa.v2x.Persistent
displayName: Migrate JDO > JPA-v2.x for @Persistent
description: Migrate @Persistent to @OneToMany and @Column.
tags:
  - jdo
  - jpa
  - migrate
  - modernize
  - java
  - javax
  - persistence
  - Persistent
recipeList:
  - com.ecpnv.openrewrite.jdo2jpa.ReplacePersistentWithOneToManyAnnotation:
      defaultCascade: 'CascadeType.PERSIST, CascadeType.MERGE, CascadeType.REFRESH, CascadeType.DETACH'
  - com.ecpnv.openrewrite.jdo2jpa.ReplacePersistentFetchGroupWithColumnAnnotation
  - org.openrewrite.java.RemoveAnnotationAttribute:
      annotationType: javax.jdo.annotations.Persistent
      attributeName: defaultFetchGroup
  - com.ecpnv.openrewrite.java.RemoveAnnotationWithoutAttributes:
      annotationType: '@javax.jdo.annotations.Persistent'
---
type: specs.openrewrite.org/v1beta/recipe
name: com.ecpnv.openrewrite.jdo2jpa.v2x.Column
displayName: Migrate JDO > JPA-v2.x for @Column
description: Migrate @Column.
tags:
  - jdo
  - jpa
  - migrate
  - modernize
  - java
  - javax
  - persistence
  - Persistent
recipeList:
  # replace @Column(..allowsNull..) with @Column(..nullable..)
  - org.openrewrite.java.ChangeAnnotationAttributeName:
      annotationType: javax.jdo.annotations.Column
      oldAttributeName: allowsNull
      newAttributeName: nullable
  # replace 'jdbcType = "CLOB", sqlType = "LONGVARCHAR"' with @Lob
  - com.ecpnv.openrewrite.java.AddAnnotationConditionally:
      matchByRegularExpression: '@Column\(.*jdbcType\s*=\s*"CLOB".*\)'
      annotationType: javax.persistence.Lob
      attributeTemplate: @Lob
  - org.openrewrite.java.RemoveAnnotationAttribute:
      annotationType: javax.jdo.annotations.Column
      attributeName: jdbcType
  - org.openrewrite.java.RemoveAnnotationAttribute:
      annotationType: javax.jdo.annotations.Column
      attributeName: sqlType
